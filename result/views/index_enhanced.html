<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Live Results - Voting Dashboard</title>
    <base href="/index.html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      [data-theme="dark"] { color-scheme: dark; }
      body { transition: background-color 0.3s, color 0.3s; }
      .pulse { animation: pulse-animation 2s infinite; }
      @keyframes pulse-animation {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .chart-container { position: relative; height: 300px; max-width: 400px; margin: 0 auto; }
      .competition-card { transition: transform 0.2s, box-shadow 0.2s; }
      .competition-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
      .fade-in { animation: fadeIn 0.5s ease-in; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .winner-badge { animation: bounce 2s infinite; }
      @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
      .view-tab { border-bottom: 3px solid transparent; transition: all 0.3s; cursor: pointer; }
      .view-tab.active { border-bottom-color: #8B5CF6; font-weight: 600; color: #8B5CF6; }
      .view-container { display: none; }
      .view-container.active { display: block; }
    </style>
  </head>
  <body class="bg-gradient-to-br from-purple-50 to-pink-100 dark:from-slate-900 dark:to-slate-800 text-gray-900 dark:text-gray-100">
    <div class="min-h-screen p-4 md:p-8">
      <!-- Header -->
      <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
        <div>
          <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400">
            üìä Live Results Dashboard
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">Real-time voting analytics ‚Ä¢ Updated every second</p>
        </div>
        <div class="flex gap-2 items-center flex-wrap">
          <button id="theme-toggle" class="bg-gray-200 dark:bg-gray-700 p-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            <span class="hidden dark:inline">‚òÄÔ∏è</span>
            <span class="inline dark:hidden">üåô</span>
          </button>
          <a href="http://localhost:8080" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
            <i class="fas fa-vote-yea"></i> Go Vote
          </a>
        </div>
      </div>

      <!-- View Tabs -->
      <div class="mb-6 flex gap-4 overflow-x-auto pb-2">
        <button onclick="switchView('cards')" id="tab-cards" class="view-tab px-4 py-2 active">
          <i class="fas fa-th-large"></i> Cards
        </button>
        <button onclick="switchView('charts')" id="tab-charts" class="view-tab px-4 py-2">
          <i class="fas fa-chart-pie"></i> Charts
        </button>
        <button onclick="switchView('table')" id="tab-table" class="view-tab px-4 py-2">
          <i class="fas fa-table"></i> Table
        </button>
        <button onclick="switchView('leaderboard')" id="tab-leaderboard" class="view-tab px-4 py-2">
          <i class="fas fa-trophy"></i> Leaderboard
        </button>
      </div>

      <!-- Filter Bar -->
      <div class="mb-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg p-4">
        <div class="flex flex-wrap gap-4 items-center">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-semibold mb-2">Filter by Status</label>
            <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500" onchange="applyFilters()">
              <option value="all">All Competitions</option>
              <option value="active">Active Only</option>
              <option value="closed">Closed Only</option>
            </select>
          </div>
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-semibold mb-2">Sort by</label>
            <select id="sort-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500" onchange="applyFilters()">
              <option value="recent">Most Recent</option>
              <option value="votes">Most Votes</option>
              <option value="name">Name (A-Z)</option>
              <option value="close">Close Margin</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="refreshData()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- Global Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Total Votes</div>
              <div class="text-4xl font-bold mt-2" id="total-votes">0</div>
              <div class="text-sm mt-2 pulse">‚óè Live</div>
            </div>
            <i class="fas fa-vote-yea text-5xl opacity-20"></i>
          </div>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Active</div>
              <div class="text-4xl font-bold mt-2" id="active-competitions">0</div>
              <div class="text-sm mt-2">In Progress</div>
            </div>
            <i class="fas fa-fire text-5xl opacity-20"></i>
          </div>
        </div>

        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Completed</div>
              <div class="text-4xl font-bold mt-2" id="closed-competitions">0</div>
              <div class="text-sm mt-2">Closed</div>
            </div>
            <i class="fas fa-check-circle text-5xl opacity-20"></i>
          </div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Avg Votes</div>
              <div class="text-4xl font-bold mt-2" id="avg-votes">0</div>
              <div class="text-sm mt-2">Per Competition</div>
            </div>
            <i class="fas fa-chart-line text-5xl opacity-20"></i>
          </div>
        </div>
      </div>

      <!-- Cards View -->
      <div id="view-cards" class="view-container active">
        <div id="competitions-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        </div>
      </div>

      <!-- Charts View -->
      <div id="view-charts" class="view-container">
        <div id="charts-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        </div>
      </div>

      <!-- Table View -->
      <div id="view-table" class="view-container">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-purple-500 text-white">
                <tr>
                  <th class="px-6 py-4 text-left">Rank</th>
                  <th class="px-6 py-4 text-left">Competition</th>
                  <th class="px-6 py-4 text-center">Status</th>
                  <th class="px-6 py-4 text-right">Option A</th>
                  <th class="px-6 py-4 text-right">Option B</th>
                  <th class="px-6 py-4 text-right">Total</th>
                  <th class="px-6 py-4 text-center">Winner</th>
                </tr>
              </thead>
              <tbody id="table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Leaderboard View -->
      <div id="view-leaderboard" class="view-container">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
              <i class="fas fa-fire text-orange-500"></i> Most Popular
            </h3>
            <div id="popular-list" class="space-y-4">
            </div>
          </div>

          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
              <i class="fas fa-balance-scale text-blue-500"></i> Closest Races
            </h3>
            <div id="close-races-list" class="space-y-4">
            </div>
          </div>

          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
              <i class="fas fa-crown text-yellow-500"></i> Biggest Wins
            </h3>
            <div id="landslide-list" class="space-y-4">
            </div>
          </div>

          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">
              <i class="fas fa-clock text-green-500"></i> Latest
            </h3>
            <div id="recent-list" class="space-y-4">
            </div>
          </div>
        </div>
      </div>

      <!-- No Competitions -->
      <div id="no-competitions" class="text-center py-16 hidden">
        <div class="text-6xl mb-4">üìä</div>
        <h2 class="text-2xl font-bold mb-2">No Competitions Yet</h2>
        <p class="text-gray-600 dark:text-gray-400 mb-6">Check back soon!</p>
        <a href="http://localhost:8080" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">
          <i class="fas fa-plus"></i> Create Competition
        </a>
      </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
      let allCompetitions = [];
      let chartsMap = new Map();
      let currentView = 'cards';

      // Theme Toggle
      const themeToggle = document.getElementById('theme-toggle');
      const html = document.documentElement;
      const theme = localStorage.getItem('theme') || 'light';
      
      if (theme === 'dark') {
        html.setAttribute('data-theme', 'dark');
        html.classList.add('dark');
      }
      
      themeToggle.addEventListener('click', () => {
        if (html.hasAttribute('data-theme')) {
          html.removeAttribute('data-theme');
          html.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          html.setAttribute('data-theme', 'dark');
          html.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      });

      // Socket.io
      const socket = io();
      socket.on('scores', function(data) {
        allCompetitions = JSON.parse(data);
        updateUI();
      });

      function switchView(view) {
        currentView = view;
        document.querySelectorAll('.view-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.view-container').forEach(container => container.classList.remove('active'));
        document.getElementById(`tab-${view}`).classList.add('active');
        document.getElementById(`view-${view}`).classList.add('active');
        updateUI();
      }

      function applyFilters() {
        updateUI();
      }

      function refreshData() {
        fetch('/api/scores').then(r => r.json()).then(data => {
          allCompetitions = data;
          updateUI();
        });
      }

      function getFilteredCompetitions() {
        const statusFilter = document.getElementById('status-filter').value;
        const sortBy = document.getElementById('sort-select').value;
        
        let filtered = allCompetitions.filter(comp => {
          if (statusFilter === 'all') return true;
          return comp.status === statusFilter;
        });

        filtered.sort((a, b) => {
          const totalA = a.a + a.b;
          const totalB = b.a + b.b;
          
          if (sortBy === 'votes') return totalB - totalA;
          if (sortBy === 'name') return a.name.localeCompare(b.name);
          if (sortBy === 'close') {
            const marginA = Math.abs(a.a - a.b);
            const marginB = Math.abs(b.a - b.b);
            return marginA - marginB;
          }
          return 0; // recent (default order)
        });

        return filtered;
      }

      function updateUI() {
        const competitions = getFilteredCompetitions();

        if (!competitions || competitions.length === 0) {
          document.getElementById('no-competitions').classList.remove('hidden');
          document.querySelectorAll('.view-container').forEach(c => c.style.display = 'none');
          updateGlobalStats(allCompetitions);
          return;
        }

        document.getElementById('no-competitions').classList.add('hidden');
        document.querySelectorAll('.view-container').forEach(c => c.style.display = '');
        document.getElementById(`view-${currentView}`).classList.add('active');

        updateGlobalStats(allCompetitions);

        if (currentView === 'cards') updateCardsView(competitions);
        else if (currentView === 'charts') updateChartsView(competitions);
        else if (currentView === 'table') updateTableView(competitions);
        else if (currentView === 'leaderboard') updateLeaderboardView(allCompetitions);
      }

      function updateGlobalStats(competitions) {
        let totalVotes = 0;
        let activeCount = 0;
        let closedCount = 0;

        competitions.forEach(comp => {
          totalVotes += (comp.a + comp.b);
          if (comp.status === 'active') activeCount++;
          if (comp.status === 'closed') closedCount++;
        });

        const avgVotes = competitions.length > 0 ? Math.round(totalVotes / competitions.length) : 0;

        document.getElementById('total-votes').textContent = totalVotes;
        document.getElementById('active-competitions').textContent = activeCount;
        document.getElementById('closed-competitions').textContent = closedCount;
        document.getElementById('avg-votes').textContent = avgVotes;
      }

      function updateCardsView(competitions) {
        const container = document.getElementById('competitions-container');
        container.innerHTML = competitions.map(comp => {
          const total = comp.a + comp.b;
          const percentA = total === 0 ? 0 : ((comp.a / total) * 100).toFixed(1);
          const percentB = total === 0 ? 0 : ((comp.b / total) * 100).toFixed(1);
          const winner = comp.a > comp.b ? 'A' : (comp.b > comp.a ? 'B' : 'Tie');
          const statusBadge = comp.status === 'active' 
            ? '<span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs px-3 py-1 rounded-full font-semibold">üü¢ Active</span>'
            : '<span class="bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs px-3 py-1 rounded-full font-semibold">‚õî Closed</span>';

          return `
            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 competition-card fade-in">
              <div class="mb-4 flex justify-between items-start">
                <div class="flex-1">
                  <h2 class="text-xl font-bold mb-2">${comp.name}</h2>
                  ${comp.description ? `<p class="text-sm text-gray-600 dark:text-gray-400">${comp.description}</p>` : ''}
                </div>
                <div>${statusBadge}</div>
              </div>

              <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                  <label class="font-semibold text-gray-800 dark:text-gray-200">
                    ${winner === 'A' ? 'üëë ' : ''}${comp.option_a}
                  </label>
                  <span class="text-2xl font-bold">${comp.a}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                  <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-full rounded-full transition-all duration-500" style="width: ${percentA}%"></div>
                </div>
                <div class="text-right text-sm text-gray-600 dark:text-gray-400 mt-1">${percentA}%</div>
              </div>

              <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                  <label class="font-semibold text-gray-800 dark:text-gray-200">
                    ${winner === 'B' ? 'üëë ' : ''}${comp.option_b}
                  </label>
                  <span class="text-2xl font-bold">${comp.b}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                  <div class="bg-gradient-to-r from-red-400 to-red-600 h-full rounded-full transition-all duration-500" style="width: ${percentB}%"></div>
                </div>
                <div class="text-right text-sm text-gray-600 dark:text-gray-400 mt-1">${percentB}%</div>
              </div>

              <div class="pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  Total: <span class="font-bold">${total}</span>
                </div>
                ${winner !== 'Tie' ? `<span class="text-sm font-bold text-purple-600 dark:text-purple-400">${comp[winner === 'A' ? 'option_a' : 'option_b']} leads!</span>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      function updateChartsView(competitions) {
        const container = document.getElementById('charts-container');
        container.innerHTML = competitions.map((comp, idx) => `
          <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 fade-in">
            <h3 class="text-xl font-bold mb-4">${comp.name}</h3>
            <div class="chart-container">
              <canvas id="chart-${idx}"></canvas>
            </div>
            <div class="text-center mt-4 text-sm text-gray-600 dark:text-gray-400">
              Total: ${comp.a + comp.b} votes
            </div>
          </div>
        `).join('');

        // Create charts
        setTimeout(() => {
          competitions.forEach((comp, idx) => {
            const canvas = document.getElementById(`chart-${idx}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: [comp.option_a, comp.option_b],
                datasets: [{
                  data: [comp.a, comp.b],
                  backgroundColor: ['#3B82F6', '#EF4444'],
                  borderWidth: 2,
                  borderColor: '#fff'
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { position: 'bottom' }
                }
              }
            });
          });
        }, 100);
      }

      function updateTableView(competitions) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = competitions.map((comp, idx) => {
          const total = comp.a + comp.b;
          const winner = comp.a > comp.b ? comp.option_a : (comp.b > comp.a ? comp.option_b : 'Tie');
          const statusBadge = comp.status === 'active' ? 'üü¢' : '‚õî';
          
          return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
              <td class="px-6 py-4 font-bold">#${idx + 1}</td>
              <td class="px-6 py-4">${comp.name}</td>
              <td class="px-6 py-4 text-center">${statusBadge}</td>
              <td class="px-6 py-4 text-right font-semibold">${comp.a}</td>
              <td class="px-6 py-4 text-right font-semibold">${comp.b}</td>
              <td class="px-6 py-4 text-right font-bold">${total}</td>
              <td class="px-6 py-4 text-center">
                ${winner !== 'Tie' ? `<span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded-full text-xs font-semibold">üëë ${winner}</span>` : 'Tie'}
              </td>
            </tr>
          `;
        }).join('');
      }

      function updateLeaderboardView(competitions) {
        // Most Popular
        const popular = [...competitions].sort((a, b) => (b.a + b.b) - (a.a + a.b)).slice(0, 5);
        document.getElementById('popular-list').innerHTML = popular.map((c, i) => `
          <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-2xl font-bold text-orange-500">#${i + 1}</div>
            <div class="flex-1">
              <div class="font-semibold">${c.name}</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">${c.a + c.b} total votes</div>
            </div>
          </div>
        `).join('');

        // Closest Races
        const close = [...competitions].sort((a, b) => Math.abs(a.a - a.b) - Math.abs(b.a - b.b)).slice(0, 5);
        document.getElementById('close-races-list').innerHTML = close.map((c, i) => `
          <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-2xl font-bold text-blue-500">#${i + 1}</div>
            <div class="flex-1">
              <div class="font-semibold">${c.name}</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">Margin: ${Math.abs(c.a - c.b)} votes</div>
            </div>
          </div>
        `).join('');

        // Biggest Wins
        const landslides = [...competitions].filter(c => c.a + c.b > 0).sort((a, b) => Math.abs(b.a - b.b) - Math.abs(a.a - a.b)).slice(0, 5);
        document.getElementById('landslide-list').innerHTML = landslides.map((c, i) => {
          const margin = Math.abs(c.a - c.b);
          const total = c.a + c.b;
          const percent = total > 0 ? ((margin / total) * 100).toFixed(1) : 0;
          return `
            <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <div class="text-2xl font-bold text-yellow-500">#${i + 1}</div>
              <div class="flex-1">
                <div class="font-semibold">${c.name}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">${percent}% margin</div>
              </div>
            </div>
          `;
        }).join('');

        // Latest
        const recent = competitions.slice(0, 5);
        document.getElementById('recent-list').innerHTML = recent.map((c, i) => `
          <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
            <div class="text-2xl font-bold text-green-500">#${i + 1}</div>
            <div class="flex-1">
              <div class="font-semibold">${c.name}</div>
              <div class="text-sm text-gray-600 dark:text-gray-400">${c.a + c.b} votes</div>
            </div>
          </div>
        `).join('');
      }

      // Initial load
      fetch('/api/scores').then(r => r.json()).then(data => {
        allCompetitions = data;
        updateUI();
      });

      // Auto-refresh
      setInterval(() => {
        fetch('/api/scores').then(r => r.json()).then(data => {
          allCompetitions = data;
          updateUI();
        });
      }, 1000);
    </script>
  </body>
</html>
