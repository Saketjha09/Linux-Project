<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Live Results - Voting Dashboard</title>
    <base href="/index.html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="docker-compose, docker, voting, results">
    <meta name="author" content="Docker Voting App">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      [data-theme="dark"] { color-scheme: dark; }
      body { transition: background-color 0.3s, color 0.3s; }
      .pulse { animation: pulse-animation 2s infinite; }
      @keyframes pulse-animation {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .chart-container { position: relative; height: 300px; max-width: 400px; margin: 0 auto; }
      .competition-card { transition: transform 0.2s, box-shadow 0.2s; }
      .competition-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
      .fade-in { animation: fadeIn 0.5s ease-in; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .winner-badge { animation: bounce 2s infinite; }
      @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
      .view-tab { border-bottom: 3px solid transparent; transition: all 0.3s; }
      .view-tab.active { border-bottom-color: #8B5CF6; font-weight: 600; }
    </style>
  </head>
  <body class="bg-gradient-to-br from-purple-50 to-pink-100 dark:from-slate-900 dark:to-slate-800 text-gray-900 dark:text-gray-100">
    <div class="min-h-screen p-4 md:p-8">
      <!-- Header -->
      <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
        <div>
          <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400">
            üìä Live Results Dashboard
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">Real-time voting analytics ‚Ä¢ Updated every second</p>
        </div>
        <div class="flex gap-2 items-center">
          <button id="theme-toggle" class="bg-gray-200 dark:bg-gray-700 p-2 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            <span class="hidden dark:inline">‚òÄÔ∏è</span>
            <span class="inline dark:hidden">üåô</span>
          </button>
          <a href="http://localhost:8080" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
            <i class="fas fa-vote-yea"></i> Go Vote
          </a>
        </div>
      </div>

      <!-- View Tabs -->
      <div class="mb-6 flex gap-4 overflow-x-auto pb-2">
        <button onclick="switchView('cards')" id="tab-cards" class="view-tab px-4 py-2 active">
          <i class="fas fa-th-large"></i> Cards View
        </button>
        <button onclick="switchView('charts')" id="tab-charts" class="view-tab px-4 py-2">
          <i class="fas fa-chart-pie"></i> Charts View
        </button>
        <button onclick="switchView('table')" id="tab-table" class="view-tab px-4 py-2">
          <i class="fas fa-table"></i> Table View
        </button>
        <button onclick="switchView('leaderboard')" id="tab-leaderboard" class="view-tab px-4 py-2">
          <i class="fas fa-trophy"></i> Leaderboard
        </button>
      </div>

      <!-- Filter Bar -->
      <div class="mb-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg p-4">
        <div class="flex flex-wrap gap-4 items-center">
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-semibold mb-2">Filter by Status</label>
            <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500" onchange="applyFilters()">
              <option value="all">All Competitions</option>
              <option value="active">Active Only</option>
              <option value="closed">Closed Only</option>
            </select>
          </div>
          <div class="flex-1 min-w-[200px]">
            <label class="block text-sm font-semibold mb-2">Sort by</label>
            <select id="sort-select" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-700 focus:ring-2 focus:ring-purple-500" onchange="applyFilters()">
              <option value="recent">Most Recent</option>
              <option value="votes">Most Votes</option>
              <option value="name">Name (A-Z)</option>
              <option value="close">Close Margin</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="refreshData()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- Global Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Votes -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Total Votes</div>
              <div class="text-4xl font-bold mt-2" id="total-votes">0</div>
              <div class="text-sm mt-2 pulse">‚óè Live Updates</div>
            </div>
            <i class="fas fa-vote-yea text-5xl opacity-20"></i>
          </div>
        </div>

        <!-- Active Competitions -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Active Now</div>
              <div class="text-4xl font-bold mt-2" id="active-competitions">0</div>
              <div class="text-sm mt-2">Voting in Progress</div>
            </div>
            <i class="fas fa-fire text-5xl opacity-20"></i>
          </div>
        </div>

        <!-- Closed Competitions -->
        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Completed</div>
              <div class="text-4xl font-bold mt-2" id="closed-competitions">0</div>
              <div class="text-sm mt-2">Voting Closed</div>
            </div>
            <i class="fas fa-check-circle text-5xl opacity-20"></i>
          </div>
        </div>

        <!-- Participation Rate -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold opacity-90">Avg Votes/Comp</div>
              <div class="text-4xl font-bold mt-2" id="avg-votes">0</div>
              <div class="text-sm mt-2">Participation</div>
            </div>
            <i class="fas fa-chart-line text-5xl opacity-20"></i>
          </div>
        </div>
      </div>

      <!-- Competitions Grid -->
      <div id="competitions-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Dynamically populated with competition cards -->
      </div>

      <!-- No Competitions Message -->
      <div id="no-competitions" class="text-center py-16 hidden">
        <div class="text-6xl mb-4">ÔøΩÔ∏è</div>
        <h2 class="text-2xl font-bold mb-2">No Competitions Yet</h2>
        <p class="text-gray-600 dark:text-gray-400">
          Check back soon for voting results!
        </p>
      </div>

      <!-- Action Links -->
      <div class="text-center space-y-4 mt-8">
        <a href="http://localhost:8080" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">
          üó≥Ô∏è Go Vote
        </a>
        <div class="text-xs text-gray-500 dark:text-gray-400">
          Updates live every second
        </div>
      </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
      // Theme Toggle
      const themeToggle = document.getElementById('theme-toggle');
      const html = document.documentElement;
      const theme = localStorage.getItem('theme') || 'light';
      
      if (theme === 'dark') {
        html.setAttribute('data-theme', 'dark');
        html.classList.add('dark');
      }
      
      themeToggle.addEventListener('click', () => {
        if (html.hasAttribute('data-theme')) {
          html.removeAttribute('data-theme');
          html.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        } else {
          html.setAttribute('data-theme', 'dark');
          html.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }
      });

      let chartsMap = new Map();

      // Socket.io Connection
      const socket = io();
      
      socket.on('scores', function(data) {
        const competitions = JSON.parse(data);
        updateUI(competitions);
      });

      function updateUI(competitions) {
        if (!competitions || competitions.length === 0) {
          document.getElementById('competitions-container').innerHTML = '';
          document.getElementById('no-competitions').classList.remove('hidden');
          document.getElementById('total-votes').textContent = '0';
          document.getElementById('active-competitions').textContent = '0';
          document.getElementById('closed-competitions').textContent = '0';
          return;
        }

        document.getElementById('no-competitions').classList.add('hidden');

        let totalVotes = 0;
        let activeCount = 0;
        let closedCount = 0;

        // Update global stats
        competitions.forEach(comp => {
          const compTotal = comp.a + comp.b;
          totalVotes += compTotal;
          if (comp.status === 'active') activeCount++;
          if (comp.status === 'closed') closedCount++;
        });

        document.getElementById('total-votes').textContent = totalVotes;
        document.getElementById('active-competitions').textContent = activeCount;
        document.getElementById('closed-competitions').textContent = closedCount;

        // Update competition cards
        const container = document.getElementById('competitions-container');
        
        competitions.forEach((comp, index) => {
          let card = document.getElementById(`comp-card-${comp.id}`);
          
          if (!card) {
            // Create new card
            card = createCompetitionCard(comp, index);
            container.appendChild(card);
          } else {
            // Update existing card
            updateCompetitionCard(card, comp, index);
          }
        });

        // Remove cards for deleted competitions
        const existingCards = container.querySelectorAll('[id^="comp-card-"]');
        existingCards.forEach(card => {
          const compId = card.id.replace('comp-card-', '');
          if (!competitions.find(c => c.id.toString() === compId)) {
            card.remove();
          }
        });
      }

      function createCompetitionCard(comp, index) {
        const card = document.createElement('div');
        card.id = `comp-card-${comp.id}`;
        card.className = 'bg-white dark:bg-slate-800 rounded-xl shadow-lg p-6 competition-card';
        
        const a = comp.a || 0;
        const b = comp.b || 0;
        const total = a + b;
        const percentA = total === 0 ? 0 : ((a / total) * 100).toFixed(1);
        const percentB = total === 0 ? 0 : ((b / total) * 100).toFixed(1);

        const statusBadge = comp.status === 'active' 
          ? '<span class="inline-block bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs px-3 py-1 rounded-full font-semibold">üü¢ Active</span>'
          : '<span class="inline-block bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs px-3 py-1 rounded-full font-semibold">‚õî Closed</span>';

        card.innerHTML = `
          <div class="mb-4 flex justify-between items-start">
            <div>
              <h2 class="text-xl font-bold" id="comp-name-${comp.id}">${comp.name}</h2>
              ${comp.description ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${comp.description}</p>` : ''}
            </div>
            <div>${statusBadge}</div>
          </div>

          <!-- Option A -->
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <label class="font-semibold text-gray-800 dark:text-gray-200">${comp.option_a}</label>
              <span class="text-2xl font-bold" id="votes-a-${comp.id}">${a}</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
              <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-full rounded-full transition-all duration-300" style="width: ${percentA}%"></div>
            </div>
            <div class="text-right text-sm text-gray-600 dark:text-gray-400 mt-1" id="percent-a-${comp.id}">${percentA}%</div>
          </div>

          <!-- Option B -->
          <div>
            <div class="flex justify-between items-center mb-2">
              <label class="font-semibold text-gray-800 dark:text-gray-200">${comp.option_b}</label>
              <span class="text-2xl font-bold" id="votes-b-${comp.id}">${b}</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
              <div class="bg-gradient-to-r from-red-400 to-red-600 h-full rounded-full transition-all duration-300" style="width: ${percentB}%"></div>
            </div>
            <div class="text-right text-sm text-gray-600 dark:text-gray-400 mt-1" id="percent-b-${comp.id}">${percentB}%</div>
          </div>

          <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Total Votes: <span class="font-bold" id="total-${comp.id}">${total}</span>
            </div>
          </div>
        `;

        return card;
      }

      function updateCompetitionCard(card, comp, index) {
        const a = comp.a || 0;
        const b = comp.b || 0;
        const total = a + b;
        const percentA = total === 0 ? 0 : ((a / total) * 100).toFixed(1);
        const percentB = total === 0 ? 0 : ((b / total) * 100).toFixed(1);

        // Update text content
        document.getElementById(`comp-name-${comp.id}`).textContent = comp.name;
        document.getElementById(`votes-a-${comp.id}`).textContent = a;
        document.getElementById(`votes-b-${comp.id}`).textContent = b;
        document.getElementById(`percent-a-${comp.id}`).textContent = percentA + '%';
        document.getElementById(`percent-b-${comp.id}`).textContent = percentB + '%';
        document.getElementById(`total-${comp.id}`).textContent = total;

        // Update progress bars
        const bars = card.querySelectorAll('div[style*="width"]');
        if (bars.length >= 2) {
          bars[0].style.width = percentA + '%';
          bars[1].style.width = percentB + '%';
        }

        // Update status badge
        const badgeEl = card.querySelector('[id*="badge"]');
        if (badgeEl) {
          if (comp.status === 'active') {
            badgeEl.innerHTML = '<span class="inline-block bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs px-3 py-1 rounded-full font-semibold">üü¢ Active</span>';
          } else {
            badgeEl.innerHTML = '<span class="inline-block bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs px-3 py-1 rounded-full font-semibold">‚õî Closed</span>';
          }
        }
      }

      // Initial load via HTTP (fallback if WebSocket doesn't update)
      fetch('/api/scores').then(r => r.json()).then(competitions => updateUI(competitions)).catch(() => {});

      // Auto-refresh every 1 second
      setInterval(() => {
        fetch('/api/scores').then(r => r.json()).then(competitions => updateUI(competitions)).catch(() => {});
      }, 1000);
    </script>
  </body>
</html>
